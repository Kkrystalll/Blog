---
title: Docker - é€£æ¥åˆ° EC2 instance ä¸¦ä¸‹è¼‰ Docker
tags:
  - Docker
  - éƒ¨ç½²
  - AWS
  - EC2
comments: false
toc: true
cover: /image/docker.webp
categories:
  - Docker
  - éƒ¨ç½²
  - AWS
date: 2023-10-05 14:24:19
---

å…ˆå‰æˆ‘å€‘å¯ä»¥ä½¿ç”¨ docker compose up ï¼Œæ˜¯å› ç‚ºä»–å¯ä»¥æ ¹æ“šæˆ‘æœ¬æ©Ÿçš„ Dockerfile è£½æˆä¸€é¡† Image ï¼Œä¸¦ä½¿ç”¨ compose å•Ÿå‹• app èˆ‡ db å…©å€‹æœå‹™ï¼Œæˆ‘ç¾åœ¨å¸Œæœ›å¯ä»¥å°‡é€™å€‹æˆ‘åœ¨æœ¬æ©Ÿé‹ä½œçš„æµç¨‹ï¼Œæ¬åˆ° EC2 (é ç«¯) ä¾†å¯¦ä½œï¼Œå¦‚æ­¤ä¸€ä¾†ï¼Œä»»ä½•äººåªè¦æœ‰ç¶²å€æˆ– ip åœ°å€ï¼Œéƒ½å¯ä»¥é€éåœ¨ç€è¦½å™¨æœå°‹çœ‹åˆ°æˆ‘çš„å°ˆæ¡ˆï¼Œä¹Ÿå°±æ˜¯é”æˆéƒ¨ç½²çš„æ•ˆæœã€‚

åœ¨é€™ä¹‹å‰æˆ‘è¦åœ¨ EC2 è£¡é¢è·‘ Dockerï¼Œæ‰€ä»¥æˆ‘éœ€è¦å…ˆé€£æ¥åˆ° EC2 ä»¥åŠ åœ¨ EC2 instance è£¡ä¸‹è¼‰ Dockerã€‚

## é€£æ¥åˆ° AWS EC2

ä»€éº¼è·Ÿ AWS EC2 é€£æ¥ï¼Ÿç‚ºä»€éº¼è¦é€£æ¥ï¼ŸğŸ¤¯
å…¶å¯¦èªªç™½è©±å°±æ˜¯ï¼Œå»ºç«‹æˆ‘æœ¬æ©Ÿè·Ÿ AWS EC2 çš„ç¶²è·¯é€£æ¥ã€‚é€éé€£æ¥ï¼Œä½¿æˆ‘å€‘å¯ä»¥åœ¨ EC2 å¯¦ä¾‹ä¸Šé€²è¡Œé ç«¯ç®¡ç†ã€éƒ¨ç½²æ‡‰ç”¨ç¨‹å¼ã€ç›£æ§å’Œç¶­è­·ç­‰æœå‹™ã€‚
è¦é€£æ¥åˆ° AWS EC2 é¦–å…ˆæˆ‘å€‘å¯ä»¥å…ˆå‹¾é¸è¦é€£æ¥çš„ instance ï¼Œæ¥è‘—é»é¸ connect(é€£æ¥) æŒ‰éˆ•

![å„²å­˜å¯†é‘°](/image/dockerDay20/20_1.webp)

é€²åˆ° connect è£¡é¢ï¼Œå¯ä»¥çœ‹åˆ°æœ‰å¾ˆå¤šç¨®ä¸åŒçš„é€£æ¥æ–¹å¼ï¼Œé€™é‚Šå°±ç°¡å–®ä»‹ç´¹æˆ‘æœ€å¸¸ç”¨çš„å…©ç¨®ï¼š

### 1. EC2 Instance Connect

EC2 Instance Connect ä½¿ç”¨ SSH éš§é“å”è­°ï¼Œä»¥å®‰å…¨çš„æ–¹å¼é€£æ¥åˆ° EC2 ï¼Œæˆ‘å€‘ä¸éœ€è¦è‡ªå·±ç®¡ç† SSH é‡‘é‘°ã€‚æˆ‘è‡ªå·±æ˜¯æƒ³åƒæˆåœ¨ AWS è£¡å¯ä»¥ç›´æ¥é€£åˆ° EC2 çš„çµ‚ç«¯æ©Ÿã€‚

![å„²å­˜å¯†é‘°](/image/dockerDay20/20_2.webp)

é¸æ“‡ EC2 Instance Connect çš„ Tab ï¼Œç›´æ¥é»é¸å³ä¸‹è§’ connect ï¼Œå¯ä»¥çœ‹åˆ°é–‹å•Ÿä¸€å€‹æ–°çš„åˆ†é å¦‚ä¸‹åœ–æ˜¯ AWS è£¡ï¼Œå·²ç¶“é€£åˆ° EC2 çš„çµ‚ç«¯æ©Ÿï¼Œæˆ‘å€‘å¯ä»¥åœ¨é€™å€‹çµ‚ç«¯æ©Ÿè£¡ä¸‹æŒ‡ä»¤ã€‚

![å„²å­˜å¯†é‘°](/image/dockerDay20/20_3.webp)

### 2. SSH client

æˆ‘æƒ³åƒæˆæˆ‘æœ‰ä¸€æŠŠé‘°åŒ™ï¼Œå¯ä»¥ä½¿ç”¨ SSH å®¢æˆ¶ç«¯ï¼Œé€£æ¥åˆ° AWS EC2 çš„çµ‚ç«¯æ©Ÿã€‚

é¸æ“‡ SSH client çš„ Tabï¼Œå¯ä»¥çœ‹åˆ°é€™é‚Šæˆ‘å€‘è¦ä½¿ç”¨çš„é‘°åŒ™ï¼Œå°±æ˜¯æˆ‘å€‘åœ¨é–‹ instance è¨­å®šçš„å¯†é‘° `krystal.pem` ï¼Œå…¶å¯¦åœ–ç‰‡å°±æœ‰èªªæ˜æ­¥é©Ÿäº†ï¼Œä½†æˆ‘é‚„æ˜¯ä¸å®Œå…¨äº†è§£ä»–çš„æ„æ€ï¼Œæ‰€ä»¥å°±å…ˆè©¦å†èªªï¼

![å„²å­˜å¯†é‘°](/image/dockerDay20/20_4.webp)

é¦–å…ˆæ‰“é–‹çµ‚ç«¯æ©Ÿï¼Œåœ¨æˆ‘çµ‚ç«¯æ©Ÿçš„æ ¹ç›®éŒ„(æˆ–æ˜¯ä½ ç¿’æ…£é€£æ¥ EC2 çš„ç›®éŒ„)ï¼Œå°‡æˆ‘å€‘å…ˆå‰æ”¶è—å¥½çš„ `krystal.pem` æª”æ¡ˆæ‹‰åˆ°é€™å€‹ç›®éŒ„ä¸‹ï¼Œä¸¦ä¸”åŸ·è¡Œé€£æ¥çœ‹çœ‹ `ssh -i "krystal.pem" ec2-user@ec2-52-199-213-167.ap-northeast-1.compute.amazonaws.com`

![å„²å­˜å¯†é‘°](/image/dockerDay20/20_5.webp)

> This key is not known by any other names
> Are you sure you want to continue connecting (yes/no/[fingerprint])?

æœƒçœ‹åˆ°å¦‚ä¸Šè¿°çš„å®‰å…¨æé†’ï¼Œæˆ‘å°±æŠŠå®ƒæƒ³åƒæˆé©—è­‰ï¼Œæ‰€ä»¥ç›´æ¥è¼¸å…¥ yes å³å¯ã€‚

![å„²å­˜å¯†é‘°](/image/dockerDay20/20_6.webp)

é€™æ™‚æˆ‘çœ‹åˆ°äº†ä¸Šæ–¹çœ‹èµ·ä¾†æ˜é¡¯çš„è­¦ç¤ºï¼Œçœ‹èµ·ä¾†ä»–èªªæˆ‘çš„ `krystal.pem` å¤ªé–‹æ”¾ï¼Ÿï¼æˆ‘çŒœæƒ³æ˜¯æ¬Šé™çš„å•é¡Œï¼Œæ‰€ä»¥å°‡ `Permissions 0644 for 'krystal.pem' are too open.` éŒ¯èª¤è¨Šæ¯å»å•å•è°·æ­Œå¤§ç¥ï¼Œ[ç¬¬ä¸€å€‹æœå°‹çµæœ](https://stackoverflow.com/questions/29933918/ssh-key-permissions-0644-for-id-rsa-pub-are-too-open-on-mac)
çœ‹èµ·ä¾†èª¿æ•´æª”æ¡ˆæ¬Šé™å³å¯

```ruby=
chmod 400 <æª”æ¡ˆåç¨±>
```

![å„²å­˜å¯†é‘°](/image/dockerDay20/20_4.webp)

~~å·å·èªªå…¶å¯¦å‰›å‰› AWS ç¬¬ä¸‰é»ä¹Ÿæœ‰æ•™æˆ‘å€‘æ€éº¼åš ğŸ¤£ğŸ¤£~~

![å„²å­˜å¯†é‘°](/image/dockerDay20/20_8.webp)

æ²’æœ‰è¼¸å‡ºæ˜¯æ­£å¸¸çš„ï¼Œä»£è¡¨èª¿æ•´æ¬Šé™æˆåŠŸï¼

æ¥è‘—å†ä¸€æ¬¡åŸ·è¡Œ ssh é€£ç·šï¼Œçœ‹åˆ°é€™å€‹å¥‡æ€ªçš„å½¢ç‹€å°±çŸ¥é“æˆåŠŸå•¦ ğŸ¥³

![å„²å­˜å¯†é‘°](/image/dockerDay20/20_9.webp)

## åœ¨ ECR ä¸‹è¼‰ Docker

ä»¥ä¸‹åœ¨ ECR ä¸‹è¼‰ Docker æˆ‘æ˜¯åƒè€ƒ [èœé³¥å·¥ç¨‹å¸« è‚‰è±¬](https://matthung0807.blogspot.com/2023/06/aws-ec2-linux-ami-amazon-linux-2023-install-docker.html) çš„æ–‡ç« 

### æ›´æ–°å¥—ä»¶åº«

```docker
sudo yum update -y
```

![å„²å­˜å¯†é‘°](/image/dockerDay20/20_10.webp)
é€™é‚Šæœ‰å€‹å°æé†’ï¼Œä¸»è¦æ˜¯åœ¨èªª Amazon Linux æœ‰æ–°ç‰ˆæœ¬ï¼Œæˆ‘å¯ä»¥ä½¿ç”¨ `dnf upgrade --releasever=2023.2.20231002` ä¾†ä¸‹è¼‰æ–°ç‰ˆæœ¬
![å„²å­˜å¯†é‘°](/image/dockerDay20/20_11.webp)
éœ€è¦ superuser æ‰å¯ä»¥ï¼Œæ‰€ä»¥æˆ‘åŠ ä¸Š `sudo`
![å„²å­˜å¯†é‘°](/image/dockerDay20/20_12.webp)
ä¸‹è¼‰éç¨‹å¤ªé•·äº†æˆ‘å°±å…ˆçœç•¥ï¼Œä½†ä¸­é–“å¯èƒ½æœƒæå•ä¸‹è¼‰éœ€è¦èŠ±è²»å¤šå°‘å®¹é‡æ˜¯å¦é¡˜æ„ç¹¼çºŒæ›´æ–°é€™é¡çš„å•é¡Œï¼ŒæˆåŠŸäº†æœƒå‡ºç¾ `Complete!` å­—æ¨£ã€‚

### å®‰è£ Docker

```docker
sudo yum install docker
```

ä¸€æ¨£æœƒå•ä¸€äº›ä¸‹è¼‰éœ€è¦èŠ±è²»å¤šå°‘å®¹é‡æ˜¯å¦é¡˜æ„ç¹¼çºŒä¸‹è¼‰é€™é¡çš„å•é¡Œï¼ŒæˆåŠŸäº†ä¸€æ¨£æœƒå‡ºç¾ `Complete!` å­—æ¨£ã€‚

### æª¢è¦– Docker ç‰ˆæœ¬

```docker
docker --version
```

![å„²å­˜å¯†é‘°](/image/dockerDay20/20_13.webp)

### èª¿æ•´ä½¿ç”¨è€…æ“ä½œ docker çš„æ¬Šé™

```docker
sudo usermod -a -G docker ec2-user
```

é€™å€‹æŒ‡ä»¤æ˜¯å°‡ `ec2-user` é€™å€‹ä½¿ç”¨è€…åŠ åˆ° docker ä½¿ç”¨è€…ï¼Œé€™æ¨£å¯ä»¥ç²å¾—åŸ·è¡Œ Docker æ“ä½œçš„æ¬Šé™ï¼Œå°±ä¸éœ€è¦æ¯æ¬¡éƒ½ä½¿ç”¨ `sudo` ã€‚
![å„²å­˜å¯†é‘°](/image/dockerDay20/20_14.webp)

ğŸ“ é€™é‚Šæ˜¯å› ç‚º EC2 é è¨­çš„ user å«åš `ec2-user` ï¼Œä½†å¦‚æœæ‚¨æƒ³ç¢ºèªè‡ªå·±çš„åç¨±æ™‚ï¼Œå¯ä»¥ä½¿ç”¨ï¼š

```docker
whoami
```

### å•Ÿå‹• Docker æœå‹™

```docker
sudo service docker start
```

![å„²å­˜å¯†é‘°](/image/dockerDay20/20_15.webp)

### ç¢ºèª Docker æœå‹™æ˜¯å¦å•Ÿå‹•

```docker
docker ps
```

![å„²å­˜å¯†é‘°](/image/dockerDay20/20_16.webp)
ä½¿ç”¨å‡ºé¡ç‡è¶…é«˜çš„ `docker ps` ä½†æ˜¯å»çœ‹åˆ°

> permission denied while trying to connect to the Docker daemon socket

çœ‹èµ·ä¾†åˆæ˜¯æ¬Šé™å•é¡Œï¼Œä½†æˆ‘å‰›å‰›ä¸æ˜¯ `sudo usermod -a -G docker ec2-user` èª¿æ•´æ¬Šé™æˆåŠŸäº†å—ï¼Ÿ

å…¶å¯¦æ˜¯å› ç‚ºç•¶æˆ‘èª¿æ•´æ¬Šé™æˆåŠŸï¼Œæˆ‘éœ€è¦å…ˆé€€å‡º ec2 instance ï¼Œå†é‡æ–°é€²ä¾†ä¸€æ¬¡ï¼Œå°±æœƒå°‡æ–°çš„æ¬Šé™ç”Ÿæ•ˆã€‚

ğŸ“ é€€å‡ºä¸€æ¨£ä½¿ç”¨ä¹‹å‰æ•™éçš„ `control éµ + d éµ` æˆ–è¼¸å…¥ `exit å­— + enter éµ`

å†æ¬¡é€²å» instance å¾Œï¼Œå†è©¦ä¸€æ¬¡æˆåŠŸçœ‹åˆ°ç›®å‰ `docker ps` æ˜¯ç©ºçš„
![å„²å­˜å¯†é‘°](/image/dockerDay20/20_17.webp)

åˆ°é€™é‚Šæˆ‘å€‘å·²ç¶“è¬äº‹ä¿±å‚™ï¼Œæ˜å¤©å°±ä¾†å¾é€™å€‹ EC2 çš„ instance è£¡é¢ä¾†ç™»å…¥ã€æ‹‰å–æˆ‘å€‘å‰å¹¾å¤©æ¨åœ¨ Docker Hub ä¸Šçš„ image å§ï¼
